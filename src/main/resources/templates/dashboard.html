<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>WealthWise | Pop Edition</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --primary: #6C5DD3;
      --primary-light: #8075e6;
      --bg-body: #F4F5F9;
      --text-dark: #1F1C2E;
      --text-grey: #8E8E93;
      --pop-spring: cubic-bezier(0.175, 0.885, 0.32, 1.375);
    }
    body {
      font-family: 'Poppins', sans-serif;
      background-color: var(--bg-body);
      color: var(--text-dark);
      padding-bottom: 80px;
      overflow-x: hidden;
    }
    /* --- POP ANIMATIONS --- */
    @keyframes popUp {
      0% { opacity: 0; transform: scale(0.5) translateY(50px); }
      100% { opacity: 1; transform: scale(1) translateY(0); }
    }
    .pop-anim {
      animation: popUp 0.6s var(--pop-spring) forwards;
      opacity: 0;
    }
    .d-1 { animation-delay: 0.1s; }
    .d-2 { animation-delay: 0.2s; }
    .d-3 { animation-delay: 0.3s; }

    /* --- CARDS --- */
    .pop-card {
      background: white;
      border-radius: 24px;
      padding: 24px;
      box-shadow: 0 10px 40px -10px rgba(200, 200, 200, 0.3);
      border: none;
      transition: transform 0.2s var(--pop-spring), box-shadow 0.2s;
      height: 100%;
    }
    .pop-card:hover {
      transform: translateY(-5px) scale(1.02);
      box-shadow: 0 20px 50px -10px rgba(108, 93, 211, 0.15);
    }
    .stat-title {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-grey);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 5px;
    }
    .stat-value {
      font-size: 2.2rem;
      font-weight: 700;
      color: var(--text-dark);
      letter-spacing: -1px;
      word-break: break-word;
    }

    /* --- AI CARD STYLE --- */
    .ai-card {
      background: linear-gradient(135deg, #6C5DD3 0%, #a49bf5 100%);
      color: white;
      position: relative;
      overflow: hidden;
    }
    .ai-card .stat-title { color: rgba(255,255,255,0.8); }
    .ai-card-icon {
      position: absolute;
      right: -20px;
      bottom: -20px;
      font-size: 100px;
      opacity: 0.1;
      transform: rotate(-15deg);
    }
    .ai-content {
      position: relative;
      z-index: 2;
      font-weight: 500;
      font-size: 1.05rem;
      line-height: 1.5;
    }

    /* --- ALERT STYLE --- */
    .alert-pop {
      border-radius: 20px;
      border: none;
      box-shadow: 0 5px 15px rgba(255, 71, 87, 0.2);
      background-color: #fff0f1;
      color: #d63031;
    }

    /* --- WALLET CARD --- */
    .wallet-card {
      background: linear-gradient(135deg, #1F1C2E 0%, #3F3D56 100%);
      border-radius: 24px;
      padding: 25px;
      color: white;
      position: relative;
      overflow: hidden;
      margin-bottom: 15px;
      box-shadow: 0 15px 30px -5px rgba(0,0,0,0.2);
      transition: transform 0.3s var(--pop-spring);
    }
    .wallet-card:hover { transform: scale(1.03); }
    .wallet-card::before {
      content: '';
      position: absolute;
      top: -50px; right: -50px;
      width: 150px; height: 150px;
      background: rgba(255,255,255,0.05);
      border-radius: 50%;
    }
    .card-num {
      font-family: monospace;
      font-size: 1.4rem;
      letter-spacing: 3px;
      margin: 20px 0;
      text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .btn-delete-card {
      position: absolute;
      top: 15px;
      right: 15px;
      background: rgba(255,255,255,0.1);
      color: white;
      border: none;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      opacity: 0;
      transition: all 0.2s;
      cursor: pointer;
      text-decoration: none;
      z-index: 10;
    }
    .wallet-card:hover .btn-delete-card { opacity: 1; }
    .btn-delete-card:hover { background: #ff4757; transform: scale(1.1) rotate(90deg); }

    /* --- BUTTONS --- */
    .btn-pop {
      border: none;
      border-radius: 16px;
      padding: 12px;
      font-weight: 600;
      transition: transform 0.1s var(--pop-spring);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      white-space: nowrap;
    }
    .btn-pop:active { transform: scale(0.9); }
    .btn-primary-pop { background: var(--primary); color: white; box-shadow: 0 8px 20px -5px rgba(108, 93, 211, 0.4); }
    .btn-dark-pop { background: var(--text-dark); color: white; box-shadow: 0 8px 20px -5px rgba(31, 28, 46, 0.3); }
    .btn-light-pop { background: white; color: var(--text-dark); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }

    /* --- INPUTS --- */
    .pop-input {
      border: 2px solid #EEE;
      border-radius: 14px;
      padding: 14px;
      font-weight: 500;
      background: #F9F9F9;
      transition: all 0.2s;
    }
    .pop-input:focus {
      background: white;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(108, 93, 211, 0.1);
      outline: none;
    }

    .icon-box {
      width: 45px; height: 45px;
      display: flex; align-items: center; justify-content: center;
      border-radius: 50%;
    }

    /* --- MODAL --- */
    .modal-content { border-radius: 30px; border: none; overflow: hidden; }
    .modal.fade .modal-dialog { transform: scale(0.7); opacity: 0; transition: all 0.4s var(--pop-spring); }
    .modal.show .modal-dialog { transform: scale(1); opacity: 1; }
    .modal-header { padding: 30px 30px 10px; border: none; }
    .modal-body { padding: 10px 30px 30px; }

    /* --- RESPONSIVE MEDIA QUERIES --- */
    @media (max-width: 991px) {
      .col-lg-4 { margin-top: 20px; }
    }

    @media (max-width: 768px) {
      .header-container { flex-direction: column; align-items: flex-start !important; gap: 20px; }
      .header-controls { width: 100%; justify-content: space-between; flex-wrap: wrap; }
      .stat-value { font-size: 1.8rem; }
      .card-num { font-size: 1.1rem; letter-spacing: 2px; }
      .pop-card { padding: 20px; }
    }

    @media (max-width: 576px) {
      .container { padding-left: 15px; padding-right: 15px; }
      .stat-value { font-size: 1.5rem; } /* Smaller font for mobile */
      .quick-actions-row { flex-wrap: wrap; }
      .quick-actions-row .btn-pop { flex: 1 1 100%; } /* Stack buttons on tiny screens */
      .ai-card-icon { font-size: 80px; }
    }
  </style>
</head>
<body>

<div class="container py-3 py-lg-5">

  <div class="d-flex justify-content-between align-items-center mb-4 mb-md-5 pop-anim header-container">
    <div>
      <h3 class="fw-bold mb-0">WealthWise<span style="color: var(--primary)">.</span></h3>
      <p class="text-muted small fw-bold mb-0">Personal Dashboard</p>
    </div>
    <div class="d-flex gap-2 gap-md-3 align-items-center header-controls">
      <select id="currencySelect" class="form-select border-0 shadow-sm fw-bold text-primary" style="width:auto; border-radius: 12px; font-size: 0.9rem;" onchange="updateCurrency()">
        <option value="USD">USD ($)</option>
        <option value="INR">INR (₹)</option>
        <option value="EUR">EUR (€)</option>
        <option value="JPY">JPY (¥)</option>
      </select>

      <div class="bg-white px-3 py-2 rounded-pill shadow-sm d-flex align-items-center gap-2">
        <div class="bg-light rounded-circle p-1"><i class="fas fa-user text-primary"></i></div>
        <span class="fw-bold small text-truncate" style="max-width: 80px;" th:text="${user.fullName}">User</span>
      </div>

      <a href="#" data-bs-toggle="modal" data-bs-target="#cartModal" class="position-relative bg-white p-2 rounded-circle shadow-sm text-muted text-decoration-none" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
        <i class="fas fa-shopping-cart"></i>
        <span th:if="${pendingExpense != null}" class="position-absolute top-0 start-100 translate-middle p-1 bg-danger border border-light rounded-circle"></span>
      </a>

      <a href="/logout" class="btn btn-light-pop rounded-circle" style="width:40px;height:40px;"><i class="fas fa-sign-out-alt text-danger"></i></a>
    </div>
  </div>

  <div th:if="${param.payment}" class="pop-anim d-1 mb-4">
    <div class="alert alert-success d-flex align-items-center p-3 rounded-4 border-0 shadow-sm">
      <i class="fas fa-check-circle me-2"></i>
      <strong>Success!</strong>&nbsp;Payment completed.
    </div>
  </div>

  <div th:if="${param.error == 'payment_cancelled'}" class="pop-anim d-1 mb-4">
    <div class="alert alert-warning d-flex align-items-center p-3 rounded-4 border-0 shadow-sm">
      <i class="fas fa-exclamation-circle me-2"></i>
      <strong>Cancelled.</strong>&nbsp;Item saved in cart.
    </div>
  </div>

  <div class="pop-anim d-1 mb-4">
    <div class="pop-card ai-card">
      <i class="fas fa-robot ai-card-icon"></i>
      <div class="d-flex align-items-center gap-2 mb-2">
        <i class="fas fa-sparkles text-warning"></i>
        <span class="text-white-50 small fw-bold text-uppercase">AI Financial Insights</span>
      </div>
      <div class="ai-content">
            <span th:text="${data.aiInsight != null ? data.aiInsight : 'Analyzing your financial patterns...'}">
                Loading AI Insights...
            </span>
      </div>
    </div>
  </div>

  <div th:if="${not #lists.isEmpty(data.dueToday)}" class="pop-anim d-1 mb-4">
    <div class="alert alert-pop p-3">
      <div class="d-flex align-items-center mb-2">
        <div class="bg-danger text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px; flex-shrink: 0;">
          <i class="fas fa-bell"></i>
        </div>
        <h6 class="fw-bold mb-0">Payments Due Today!</h6>
      </div>
      <div class="ms-5 ps-2 border-start border-danger border-opacity-25">
        <div th:each="due : ${data.dueToday}" class="d-flex justify-content-between align-items-center mb-1">
          <span class="small fw-medium text-truncate" style="max-width: 150px;" th:text="${due.description}">Description</span>
          <span class="small fw-bold text-danger money-display" th:data-usd="${due.amount}" th:text="${'-$' + due.amount}">-$0.00</span>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-3 g-md-4 mb-4">
    <div class="col-12 col-md-4">
      <div class="pop-card pop-anim d-1">
        <div class="d-flex justify-content-between">
          <div class="stat-title">Balance</div>
          <i class="fas fa-wallet text-primary bg-light p-2 rounded-3"></i>
        </div>
        <div class="stat-value money-display" th:data-usd="${data.totalBalance}" th:text="${'$' + #numbers.formatDecimal(data.totalBalance, 1, 2)}">$0.00</div>
      </div>
    </div>

    <div class="col-12 col-sm-6 col-md-4">
      <div class="pop-card pop-anim d-2">
        <div class="d-flex justify-content-between">
          <div class="stat-title">Income</div>
          <i class="fas fa-arrow-down text-success bg-light p-2 rounded-3"></i>
        </div>
        <div class="stat-value text-success money-display" th:data-usd="${data.totalIncome}" th:text="${'$' + #numbers.formatDecimal(data.totalIncome, 1, 2)}">$0.00</div>
      </div>
    </div>

    <div class="col-12 col-sm-6 col-md-4">
      <div class="pop-card pop-anim d-3">
        <div class="d-flex justify-content-between">
          <div class="stat-title">Expenses</div>
          <i class="fas fa-arrow-up text-danger bg-light p-2 rounded-3"></i>
        </div>
        <div class="stat-value text-danger money-display" th:data-usd="${data.totalExpenses}" th:text="${'$' + #numbers.formatDecimal(data.totalExpenses, 1, 2)}">$0.00</div>
      </div>
    </div>
  </div>

  <div class="row g-4">
    <div class="col-lg-8">
      <div class="pop-card mb-4 pop-anim d-1">
        <h5 class="fw-bold mb-4">Quick Actions</h5>
        <div class="d-flex gap-3 quick-actions-row">
          <button class="btn-pop btn-primary-pop flex-fill" data-bs-toggle="modal" data-bs-target="#incomeModal">
            <i class="fas fa-plus"></i> Income
          </button>
          <button class="btn-pop btn-dark-pop flex-fill" data-bs-toggle="modal" data-bs-target="#expenseModal">
            <i class="fas fa-minus"></i> Expense
          </button>
          <button class="btn-pop btn-light-pop flex-fill" data-bs-toggle="modal" data-bs-target="#cardModal">
            <i class="far fa-credit-card"></i> Add Card
          </button>
        </div>
      </div>

      <div class="pop-card mb-4 pop-anim d-2">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h5 class="fw-bold m-0">Recent Transactions</h5>
          <span class="badge bg-light text-dark">Top 5</span>
        </div>
        <div class="d-flex flex-column gap-3">
          <div th:each="exp : ${data.recentExpenses}" class="d-flex justify-content-between align-items-center p-3 rounded-4 bg-light">
            <div class="d-flex align-items-center gap-3">
              <div class="icon-box bg-white shadow-sm flex-shrink-0" th:classappend="${exp.paymentType == 'CARD'} ? 'text-primary' : 'text-success'">
                <i class="fab fa-cc-stripe fa-lg" th:if="${exp.paymentType == 'CARD'}"></i>
                <i class="fas fa-money-bill-wave" th:unless="${exp.paymentType == 'CARD'}"></i>
              </div>
              <div class="overflow-hidden">
                <div class="fw-bold text-truncate" th:text="${exp.category}">Category</div>
                <div class="small text-muted text-truncate" th:text="${exp.description}">Description</div>
              </div>
            </div>
            <div class="fw-bold text-danger money-display flex-shrink-0" th:data-usd="${exp.amount}" th:text="${'-$' + exp.amount}">-$0.00</div>
          </div>
          <div th:if="${#lists.isEmpty(data.recentExpenses)}" class="text-center text-muted small">No transactions yet.</div>
        </div>
      </div>

      <div class="pop-card pop-anim d-3">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h5 class="fw-bold m-0">This Month's Spending</h5>
          <span class="badge bg-primary-subtle text-primary">Monthly</span>
        </div>
        <div class="table-responsive">
          <table class="table table-borderless align-middle">
            <thead class="text-muted small text-uppercase">
            <tr>
              <th style="min-width: 100px;">Date</th>
              <th style="min-width: 150px;">Details</th>
              <th class="text-end">Amount</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="mExp : ${data.monthlyExpenses}" style="border-bottom: 1px solid #f0f0f0;">
              <td class="text-muted small" th:text="${mExp.date}">2023-10-10</td>
              <td>
                <div class="d-flex align-items-center gap-2">
                  <i class="fab fa-cc-stripe text-primary" th:if="${mExp.paymentType == 'CARD'}"></i>
                  <i class="fas fa-wallet text-success" th:unless="${mExp.paymentType == 'CARD'}"></i>
                  <span class="text-truncate d-inline-block" style="max-width: 150px;" th:text="${mExp.category + ' - ' + mExp.description}">Details</span>
                </div>
              </td>
              <td class="text-end fw-bold text-danger money-display"
                  th:data-usd="${mExp.amount}"
                  th:text="${'-$' + mExp.amount}">-$0.00</td>
            </tr>
            <tr th:if="${#lists.isEmpty(data.monthlyExpenses)}">
              <td colspan="3" class="text-center text-muted py-4">No expenses this month.</td>
            </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="col-lg-4">
      <div class="pop-card h-100 pop-anim d-3">
        <h5 class="fw-bold mb-4">My Wallet</h5>
        <div th:each="card : ${data.cards}" class="wallet-card">
          <a th:href="@{/dashboard/delete-card/{id}(id=${card.id})}" class="btn-delete-card" onclick="return confirm('Remove this card?')">
            <i class="fas fa-trash-alt"></i>
          </a>
          <div class="d-flex justify-content-between align-items-start text-white-50">
            <i class="fab fa-cc-visa fa-2x text-white" th:if="${card.bankName == 'Visa'}"></i>
            <i class="fab fa-cc-mastercard fa-2x text-white" th:if="${card.bankName == 'MasterCard'}"></i>
            <i class="fas fa-credit-card fa-2x text-white" th:unless="${card.bankName == 'Visa' || card.bankName == 'MasterCard'}"></i>
            <i class="fas fa-wifi opacity-50"></i>
          </div>
          <div class="card-num" th:text="${card.cardNumber}">**** 0000 0000 0000</div>
          <div class="d-flex justify-content-between align-items-end">
            <div>
              <small class="text-white-50 small" style="font-size: 0.6rem; letter-spacing: 1px;">HOLDER</small><br>
              <span class="fw-bold text-white text-truncate d-block" style="max-width: 150px;" th:text="${user.fullName}">NAME</span>
            </div>
          </div>
        </div>
        <div th:if="${#lists.isEmpty(data.cards)}" class="text-center py-5 border border-dashed rounded-4">
          <p class="text-muted mb-0">No cards linked.</p>
        </div>
      </div>
    </div>
  </div>

</div>

<div class="modal fade" id="cartModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header border-0">
        <h5 class="fw-bold">Your Cart</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center">
        <div th:if="${pendingExpense != null}">
          <div class="bg-light p-3 rounded-4 mb-4">
            <h6 class="fw-bold text-dark mb-1" th:text="${pendingExpense.description}">Description</h6>
            <div class="small text-muted mb-2" th:text="${pendingExpense.category}">Category</div>
            <h2 class="fw-bold text-primary mb-0 money-display" th:data-usd="${pendingExpense.amount}" th:text="${'$' + pendingExpense.amount}">$0.00</h2>
          </div>
          <div class="d-flex gap-2">
            <a href="/dashboard/cart/clear" class="btn btn-light-pop flex-fill">Clear</a>
            <a href="/dashboard/checkout/retry" class="btn btn-primary-pop flex-fill">Checkout Now <i class="fas fa-arrow-right ms-2"></i></a>
          </div>
        </div>
        <div th:if="${pendingExpense == null}" class="py-4">
          <div class="text-muted mb-3"><i class="fas fa-shopping-basket fa-3x opacity-25"></i></div>
          <p class="text-muted fw-bold">Your cart is empty.</p>
          <button class="btn btn-dark-pop btn-sm" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="incomeModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="fw-bold">Add Income</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form action="/dashboard/add-income" method="post">
          <input name="source" class="form-control pop-input mb-2" placeholder="Source (e.g. Salary, Freelance)" required>
          <input name="description" class="form-control pop-input mb-2" placeholder="Description" required>
          <input name="amount" type="number" step="0.01" class="form-control pop-input mb-3" placeholder="Amount" required>
          <button class="btn-pop btn-primary-pop w-100">Save</button>
        </form>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="cardModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title fw-bold">Link New Card</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form action="/dashboard/add-card" method="post">
          <input type="hidden" name="cardHolderName" th:value="${user.fullName}">
          <input type="hidden" name="balance" value="5000.00">
          <input type="hidden" name="bankName" id="hiddenBank" value="Card">
          <input type="hidden" name="cardType" value="DEBIT">

          <div class="mb-3">
            <label class="small fw-bold text-muted ms-1 mb-1">Card Number</label>
            <div class="input-group">
                <span class="input-group-text bg-white border-end-0 border-2" style="border-radius: 14px 0 0 14px;">
                    <i id="cardIcon" class="far fa-credit-card text-muted"></i>
                </span>
              <input type="text" name="cardNumber" id="inpNum" class="form-control pop-input border-start-0"
                     style="border-radius: 0 14px 14px 0;" placeholder="0000 0000 0000 0000" maxlength="19" required>
            </div>
          </div>
          <div class="row mb-4">
            <div class="col-6">
              <label class="small fw-bold text-muted ms-1 mb-1">Expiry</label>
              <input type="text" name="expiryDate" class="form-control pop-input" placeholder="MM/YY" maxlength="5" required>
            </div>
            <div class="col-6">
              <label class="small fw-bold text-muted ms-1 mb-1">CVC</label>
              <input type="text" name="cvc" class="form-control pop-input" placeholder="123" maxlength="3" required>
            </div>
          </div>
          <button type="submit" class="btn-pop btn-primary-pop w-100 py-3">Add to Wallet</button>
        </form>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="expenseModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="fw-bold">Add Expense</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form action="/dashboard/add-expense" method="post">
          <label class="small fw-bold text-muted ms-1 mb-1">Due/Payment Date</label>
          <input type="date" name="expenseDate" class="form-control pop-input mb-3" required>

          <label class="small fw-bold text-muted ms-1 mb-1">Payment Method</label>
          <select name="paymentType" id="paymentTypeSelect" class="form-select pop-input mb-3" required>
            <option value="CASH" selected>Cash / Money</option>
            <option value="CARD">Card (Stripe Checkout)</option>
          </select>

          <label class="small fw-bold text-muted ms-1 mb-1">Details</label>
          <input name="category" class="form-control pop-input mb-2" placeholder="Category (e.g., Rent, Food)" required>
          <input name="description" class="form-control pop-input mb-2" placeholder="Description" required>

          <label class="small fw-bold text-muted ms-1 mb-1">Amount</label>
          <input name="amount" type="number" step="0.01" class="form-control pop-input mb-3" placeholder="0.00" required>

          <button id="saveExpenseBtn" class="btn-pop btn-dark-pop w-100">Save Expense</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // --- 1. DYNAMIC EXPENSE BUTTON TEXT ---
  const paySelect = document.getElementById('paymentTypeSelect');
  const saveBtn = document.getElementById('saveExpenseBtn');

  if(paySelect && saveBtn) {
    paySelect.addEventListener('change', function() {
      if(this.value === 'CARD') {
        saveBtn.innerText = 'Proceed to Payment Gateway';
        saveBtn.classList.remove('btn-dark-pop');
        saveBtn.classList.add('btn-primary-pop');
      } else {
        saveBtn.innerText = 'Save Expense';
        saveBtn.classList.remove('btn-primary-pop');
        saveBtn.classList.add('btn-dark-pop');
      }
    });
  }

  // --- 2. CARD NETWORK DETECTION ---
  const inpNum = document.getElementById('inpNum');
  const cardIcon = document.getElementById('cardIcon');
  const hiddenBank = document.getElementById('hiddenBank');

  if(inpNum) {
    inpNum.addEventListener('input', e => {
      let val = e.target.value.replace(/\D/g, '').substring(0, 16);
      e.target.value = val.match(/.{1,4}/g)?.join(' ') || val;

      if (val.startsWith('4')) {
        cardIcon.className = 'fab fa-cc-visa text-primary fa-lg';
        hiddenBank.value = 'Visa';
      } else if (val.startsWith('5')) {
        cardIcon.className = 'fab fa-cc-mastercard text-warning fa-lg';
        hiddenBank.value = 'MasterCard';
      } else {
        cardIcon.className = 'far fa-credit-card text-muted';
        hiddenBank.value = 'Card';
      }
    });
  }

  // --- 3. CURRENCY FORMATTER ---
  const rates = { USD: {r:1, s:'$'}, INR: {r:89.35, s:'₹'}, EUR: {r:0.91, s:'€'}, JPY: {r:145.5, s:'¥'} };
  function updateCurrency() {
    const code = document.getElementById('currencySelect').value;
    const rate = rates[code];
    document.querySelectorAll('.money-display').forEach(el => {
      const val = parseFloat(el.getAttribute('data-usd'));
      if(!isNaN(val)) {
        el.innerText = (val<0?'-':'') + rate.s + Math.abs(val*rate.r).toLocaleString(undefined, {minimumFractionDigits:2});
      }
    });
  }

  // --- 4. AUTO-HIDE SUCCESS ALERT ---
  const successAlert = document.querySelector('.alert-success');
  if (successAlert) {
    setTimeout(() => {
      // Fade out
      successAlert.style.transition = "opacity 0.5s ease";
      successAlert.style.opacity = "0";
      // Remove from DOM after transition
      setTimeout(() => {
        // Remove the parent container to clear spacing
        const parent = successAlert.closest('.pop-anim');
        if(parent) parent.remove();
        else successAlert.remove();
      }, 500);
    }, 2000); // 2 seconds delay
  }
</script>
</body>
</html>